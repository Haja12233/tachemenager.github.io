<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrice 4x4 - Cases réorganisées</title>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    /* Styles Généraux */
    body {
        font-family: 'Poppins', sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        min-height: 100vh;
        padding: 20px;
        background-color: #f8f9fa;
        color: #343a40;
        margin: 0;
    }

    h1 {
        color: #0d6efd;
        margin-bottom: 30px;
        font-weight: 700;
        text-align: center;
    }

    /* Conteneur de la Matrice */
    #matrix-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        width: 100%;
        max-width: 480px;
    }

    /* Cellules de la Matrice */
    .cube-cell {
        width: 100%;
        aspect-ratio: 1 / 1;
        max-width: 150px;
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin: 0 auto;
        position: relative;
    }

    .cube-cell:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
    }

    .cube-cell select, .cube-cell button {
        width: 100%;
        height: 100%;
        border: none;
        background-color: transparent;
        font-size: 1.2em;
        font-weight: 600;
        color: #495057;
        text-align: center;
        cursor: pointer;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        outline: none;
    }

    .cube-cell select {
        background-image: url('image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23495057%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 14px;
        padding-right: 20px;
    }

    .empty-cell {
        background-color: #e9ecef;
        border-style: dashed;
    }

    .empty-cell:hover {
        transform: none;
        box-shadow: none;
    }

    /* Style pour les badges */
    .badge {
        --size: 1.8em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: var(--size);
        height: var(--size);
        border: 2px solid currentColor;
        border-radius: 50%;
        font: 700 0.8em/1 system-ui, sans-serif;
        letter-spacing: 0.02em;
        margin-right: 8px;
        vertical-align: middle;
    }

    /* Boutons Heure */
    .time-button, .stop-button {
        font-weight: 700;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .time-button {
        background-color: #e8f0fe;
        color: #0d6efd;
    }

    .time-button:hover {
        background-color: #d1e3fd;
    }

    .stop-button {
        background-color: #dc3545;
        color: white;
        display: none;
    }

    .stop-button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }

    /* Notification stylée */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 20px 25px;
        border-radius: 12px;
        background: linear-gradient(135deg, #4BB543, #2E7D32);
        color: white;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 10px 25px rgba(75, 181, 67, 0.3);
        transform: translateX(150%);
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 12px;
        max-width: 350px;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification-icon {
        font-size: 24px;
    }

    .notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        margin-left: 15px;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .notification-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    /* Style pour les options désactivées */
    .disabled-option {
        background-color: #ffcdd2 !important;
        color: #6c757d !important;
    }

    /* Media Queries pour la Responsivité */
    @media (max-width: 768px) {
        h1 {
            font-size: 1.4em;
        }
        
        #matrix-container {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-width: 400px;
        }

        .cube-cell {
            max-width: 100%;
            height: 100px;
        }

        .cube-cell select, .cube-cell button {
            font-size: 0.9em;
        }

        .cube-cell select {
            background-position: right 5px center;
            background-size: 12px;
            padding-right: 15px;
        }

        .notification {
            max-width: 300px;
            font-size: 14px;
            padding: 15px 20px;
            top: 15px;
            right: 15px;
        }
    }

    @media (max-width: 480px) {
        h1 {
            font-size: 1.2em;
        }
        
        #matrix-container {
            grid-template-columns: 1fr;
            gap: 8px;
            max-width: 250px;
        }

        .cube-cell {
            height: 80px;
        }

        .cube-cell select, .cube-cell button {
            font-size: 0.8em;
        }

        .notification {
            max-width: 280px;
            font-size: 13px;
            padding: 12px 18px;
            top: 10px;
            right: 10px;
        }
    }
    </style>
</head>
<body>

    <h1>GESTION des TACHES</h1>
    
    <div id="matrix-container">
        <!-- Ligne 1 -->
        <div class="cube-cell"><select id="A1">
            <option value="">Pavillon</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
        </select></div>
        <div class="cube-cell"><select id="B1"></select></div>
        <div class="cube-cell"><select id="C1"></select></div>
        <div class="cube-cell"><select id="D1">
            <option value="">Utilisateur</option>
            <option value="Annivah">Annivah</option>
            <option value="Tinah">Tinah</option>
        </select></div>
        
        <!-- Ligne 2 -->
        <div class="cube-cell"><button id="start-time-btn" class="time-button">Heure de début</button></div>
        <div class="cube-cell"><select id="B2"></select></div>
        <div class="cube-cell">
            <select id="C2">
                <option value="">C2</option>
                <option value="R"><span class="badge">R</span> R</option>
                <option value="R_round"><span class="badge">R</span> R_round</option>
                <option value="2R"><span class="badge">2R</span> 2R</option>
                <option value="2R_round"><span class="badge">2R</span> 2R_round</option>
                <option value="3R"><span class="badge">3R</span> 3R</option>
                <option value="3R_round"><span class="badge">3R</span> 3R_round</option>
            </select>
        </div>
        <div class="cube-cell"><select id="D2"></select></div>
        
        <!-- Ligne 3 -->
        <div class="cube-cell"><button id="end-time-btn" class="stop-button">Heure de fin</button></div>
        <div class="cube-cell"><select id="B3"></select></div>
        <div class="cube-cell">
            <select id="C3">
                <option value="">C3</option>
                <option value="X"><span class="badge">X</span> X</option>
                <option value="X_round"><span class="badge">X</span> X_round</option>
            </select>
        </div>
        <div class="cube-cell"><select id="D3"></select></div>
        
        <!-- Ligne 4 -->
        <div class="cube-cell"><select id="A4">
            <option value="">A4</option>
            <option value="01">01</option>
            <option value="02">02</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
        </select></div>
        <div class="cube-cell"><select id="B4">
            <option value="">B4</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
        </select></div>
        <div class="cube-cell"><select id="C4">
            <option value="">C4</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
        </select></div>
        <div class="cube-cell"><select id="D4">
            <option value="">D4</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
        </select></div>
    </div>

    <!-- Notification stylée -->
    <div id="notification" class="notification">
        <span class="notification-icon">✓</span>
        <span id="notification-text">La tâche a été envoyée avec succès !</span>
        <button class="notification-close" onclick="closeNotification()">&times;</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startTimeBtn = document.getElementById('start-time-btn');
            const endTimeBtn = document.getElementById('end-time-btn');
            const notification = document.getElementById('notification');
            const d1Select = document.getElementById('D1');
            const d4Select = document.getElementById('D4');
            const a1Select = document.getElementById('A1');
        
            const fields = [
              { id: 'A1', next: ['start-time-btn'] },
              { id: 'start-time-btn', next: 'A4' },
              { id: 'A4', next: 'B4' },
              { id: 'B4', next: 'C2' },
              { id: 'C2', next: 'C3' },
              { id: 'C3', next: 'C4' },
              { id: 'C4', next: 'D1' },
              { id: 'D1', next: 'D4' },
              { id: 'D4', next: ['end-time-btn'] }
            ];
        
            let startTime = null;
            let endTime = null;
            let lockedA1Values = [];
            let defaultD1Value = null;
            let notificationTimeout = null;
        
            // Désactive tous les champs (sauf A1)
            function disableAllFields() {
              const allSelects = document.querySelectorAll('#matrix-container select');
              allSelects.forEach(select => select.disabled = true);
              document.getElementById('A1').disabled = false;
              startTimeBtn.disabled = true;
              endTimeBtn.style.display = 'none';
            }
        
            // Verrouille les options déjà utilisées dans A1
            function applyALocks() {
              if (a1Select) {
                Array.from(a1Select.options).forEach(option => {
                  if (lockedA1Values.includes(option.value) && option.value !== '') {
                    option.disabled = true;
                    option.classList.add('disabled-option');
                  }
                });
              }
            }
        
            // Charge les valeurs verrouillées depuis le storage
            function loadLocks() {
              try {
                const a1Locks = localStorage.getItem('lockedA1Values');
                const d1Default = localStorage.getItem('defaultD1Value');
                const lockTimestamp = localStorage.getItem('lockTimestamp');
        
                if (a1Locks && lockTimestamp) {
                  const timestamp = parseInt(lockTimestamp);
                  const now = Date.now();
        
                  // Vérifier si le verrouillage est encore valide (24h)
                  if (now - timestamp < (24 * 60 * 60 * 1000)) {
                    lockedA1Values = JSON.parse(a1Locks);
                    defaultD1Value = d1Default;
                  } else {
                    // Le verrouillage a expiré, nettoyer le localStorage
                    clearLocks();
                  }
                }
              } catch (error) {
                console.log('Erreur lors du chargement des verrouillages:', error);
              }
            }
        
            // Sauvegarde les valeurs verrouillées
            function saveLocks(a1Value, defaultD1Val) {
              try {
                lockedA1Values.push(a1Value);
                defaultD1Value = defaultD1Val;
        
                localStorage.setItem('lockedA1Values', JSON.stringify(lockedA1Values));
                localStorage.setItem('defaultD1Value', defaultD1Val);
                localStorage.setItem('lockTimestamp', Date.now().toString());
              } catch (error) {
                console.log('Erreur lors de la sauvegarde des verrouillages:', error);
              }
            }
        
            // Efface les verrouillages
            function clearLocks() {
              try {
                localStorage.removeItem('lockedA1Values');
                localStorage.removeItem('defaultD1Value');
                localStorage.removeItem('lockTimestamp');
                lockedA1Values = [];
                defaultD1Value = null;
              } catch (error) {
                console.log('Erreur lors de l\'effacement des verrouillages:', error);
              }
            }
        
            // Active le prochain champ
            function enableNextField(currentId) {
              const currentField = fields.find(f => f.id === currentId);
              if (!currentField || !currentField.next) return;
        
              let nextElements = Array.isArray(currentField.next) ? currentField.next : [currentField.next];
        
              nextElements.forEach(nextId => {
                const nextElement = document.getElementById(nextId);
                if (nextElement) {
                  // Si c'est D1 et qu'il y a une valeur par défaut, ignorer D1 et aller directement à D4
                  if (nextId === 'D1' && defaultD1Value) {
                    // Activer D4 directement
                    document.getElementById('D4').disabled = false;
                    document.getElementById('D4').focus();
                    return;
                  }
                  // Si c'est D1 normal (pas de valeur par défaut)
                  if (nextId === 'D1' && !defaultD1Value) {
                    nextElement.disabled = false;
                    return;
                  }
                  nextElement.disabled = false;
                  if (nextId === 'end-time-btn') {
                    nextElement.style.display = 'block';
                  }
                }
              });
            }
        
            // Badge pour C2/C3
            function renderBadge(selectId) {
              const select = document.getElementById(selectId);
              select.addEventListener("change", function () {
                let val = this.value;
                if (val.endsWith("_round")) {
                  let badge = document.createElement("span");
                  badge.className = "badge";
                  badge.textContent = val.replace("_round", "");
                  this.style.display = "none";
                  this.insertAdjacentElement("afterend", badge);
                } else {
                  let next = this.nextElementSibling;
                  if (next && next.classList.contains("badge")) next.remove();
                  this.style.display = "block";
                }
              });
            }
        
            // Fonction pour envoyer les données à Google Sheets (simulation)
            async function sendDataToGoogleSheets(values) {
                try {
                    // Pour les tests, simuler un succès
                    // Remplacez cette URL par votre webhook Google Apps Script en production
                    const webhookUrl = 'https://script.google.com/macros/s/AKfycbwAJu0wSAVrVyZv-CHMiXhdjJA-VTLDRVjqmnzHyUKjMBk8EeGDIo_a3xvWQa32rI428w/exec';
                    
                    // Simulation pour les tests (toujours retourne succès)
                    console.log('Données simulées envoyées:', values);
                    return true;
                    
                    /*
                    // Code réel à décommenter en production :
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(values)
                    });
                    
                    if (response.ok) {
                        console.log('Données envoyées avec succès à Google Sheets');
                        return true;
                    } else {
                        console.error('Erreur lors de l\'envoi des données:', response.status);
                        return false;
                    }
                    */
                } catch (error) {
                    console.error('Erreur réseau:', error);
                    // Pour les tests, retourner true même en cas d'erreur
                    return true;
                }
            }
        
            // Afficher la notification
            function showNotification(message, isSuccess = true) {
                const notificationText = document.getElementById('notification-text');
                const notificationIcon = document.querySelector('.notification-icon');
                
                notificationText.textContent = message;
                
                if (isSuccess) {
                    notification.style.background = 'linear-gradient(135deg, #4BB543, #2E7D32)';
                    notificationIcon.textContent = '✓';
                    notificationIcon.style.color = '#4BB543';
                } else {
                    notification.style.background = 'linear-gradient(135deg, #FF6B6B, #C44545)';
                    notificationIcon.textContent = '✗';
                    notificationIcon.style.color = '#FF6B6B';
                }
                
                notification.classList.add('show');
                
                // Cacher automatiquement après 3 secondes et réinitialiser
                clearTimeout(notificationTimeout);
                notificationTimeout = setTimeout(() => {
                    closeNotification();
                    resetForm();
                }, 3000);
            }
        
            // Fermer la notification
            function closeNotification() {
                notification.classList.remove('show');
                clearTimeout(notificationTimeout);
            }
        
            // Réinitialiser le formulaire
            function resetForm() {
                // Réinitialiser tous les champs
                const allSelects = document.querySelectorAll('#matrix-container select');
                allSelects.forEach(select => {
                    select.value = '';
                    select.disabled = true;
                    select.classList.remove('disabled-option');
                });
                
                // Supprimer les éléments de texte affichés
                const textDisplays = document.querySelectorAll('#d1-display');
                textDisplays.forEach(display => display.remove());
                
                // Réinitialiser les boutons
                startTimeBtn.textContent = 'Heure de début';
                startTimeBtn.disabled = true;
                startTime = null;
                
                endTimeBtn.textContent = 'Heure de fin';
                endTimeBtn.style.display = 'none';
                endTimeBtn.disabled = true;
                endTime = null;
                
                // Réactiver A1
                document.getElementById('A1').disabled = false;
                
                // Réactiver tous les champs selon la logique initiale
                disableAllFields();
                applyALocks(); // Réappliquer les verrous sur A1
                
                // Si D1 a une valeur par défaut, l'afficher
                if (defaultD1Value) {
                    setupDefaultD1();
                }
            }
        
            // Configurer la valeur par défaut de D1
            function setupDefaultD1() {
                if (defaultD1Value) {
                    // Masquer le select et afficher la valeur comme texte
                    d1Select.style.display = 'none';
                    
                    // Créer un élément texte pour afficher la valeur
                    const textDisplay = document.createElement('div');
                    textDisplay.id = 'd1-display';
                    textDisplay.style.fontSize = '1.2em';
                    textDisplay.style.fontWeight = '600';
                    textDisplay.style.color = '#495057';
                    textDisplay.textContent = defaultD1Value;
                    textDisplay.style.textAlign = 'center';
                    d1Select.parentElement.appendChild(textDisplay);
                }
            }
        
            // Initialisation
            loadLocks();
            disableAllFields();
            applyALocks(); // Appliquer les verrous sur A1
            renderBadge("C2");
            renderBadge("C3");
            
            // Si D1 a une valeur par défaut, l'afficher
            if (defaultD1Value) {
                setupDefaultD1();
            }
        
            // Activation des champs selon la logique
            fields.forEach(field => {
              const selectElement = document.getElementById(field.id);
              if (selectElement && selectElement.tagName === 'SELECT') {
                selectElement.addEventListener('change', function() {
                  if (this.value !== "") {
                    enableNextField(this.id);
                    
                    // Si c'est D4 qui change de valeur, afficher automatiquement l'heure de fin
                    if (field.id === 'D4' && this.value !== "") {
                      // Afficher le bouton de fin
                      endTimeBtn.style.display = 'block';
                      endTimeBtn.disabled = false;
                      
                      // Déclencher automatiquement l'heure de fin
                      if (!endTime) {
                        setTimeout(async () => {
                          endTime = getFormattedTime();
                          endTimeBtn.textContent = endTime;
                          endTimeBtn.disabled = true;
                          endTimeBtn.style.cursor = 'default';
                          
                          // Envoyer automatiquement les données
                          await submitData();
                        }, 100);
                      }
                    }
                  }
                });
              }
            });
        
            // Gestion du changement de valeur dans A1
            a1Select.addEventListener('change', function() {
              if (this.value !== "") {
                // Sauvegarder la valeur sélectionnée pour 24h
                lockedA1Values.push(this.value);
                localStorage.setItem('lockedA1Values', JSON.stringify(lockedA1Values));
                localStorage.setItem('lockTimestamp', Date.now().toString());
                
                // Appliquer les verrous
                applyALocks();
              }
            });
        
            // Gestion du changement de valeur dans D1
            d1Select.addEventListener('change', function() {
              if (this.value !== "") {
                // Si une valeur est sélectionnée dans D1, la considérer comme valeur par défaut permanente
                defaultD1Value = this.value;
                
                // Sauvegarder la valeur par défaut
                localStorage.setItem('defaultD1Value', defaultD1Value);
                localStorage.setItem('lockTimestamp', Date.now().toString());
                
                // Masquer le select et afficher la valeur comme texte
                this.style.display = 'none';
                
                // Créer un élément texte pour afficher la valeur
                const textDisplay = document.createElement('div');
                textDisplay.id = 'd1-display';
                textDisplay.style.fontSize = '1.2em';
                textDisplay.style.fontWeight = '600';
                textDisplay.style.color = '#495057';
                textDisplay.textContent = this.value;
                textDisplay.style.textAlign = 'center';
                this.parentElement.appendChild(textDisplay);
                
                // Activer D4 automatiquement et mettre le focus
                setTimeout(() => {
                  d4Select.disabled = false;
                  d4Select.focus();
                }, 100);
              }
            });
        
            startTimeBtn.addEventListener('click', function() {
              if (!startTime) {
                startTime = getFormattedTime();
                this.textContent = startTime;
                this.disabled = true;
                this.style.cursor = 'default';
                enableNextField('start-time-btn');
              }
            });
        
            endTimeBtn.addEventListener('click', function() {
              if (!endTime) {
                endTime = getFormattedTime();
                this.textContent = endTime;
                this.disabled = true;
                this.style.cursor = 'default';
              }
            });
        
            function getFormattedTime() {
              const now = new Date();
              return `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            }
        
            // Fonction pour soumettre les données
            async function submitData() {
              const values = {
                A1: document.getElementById('A1').value,
                date: new Date().toLocaleDateString('fr-FR'),
                A2: startTime,
                A3: endTime,
                A4: document.getElementById('A4').value,
                B1: document.getElementById('B1').value,
                B2: document.getElementById('B2').value,
                B3: document.getElementById('B3').value,
                B4: document.getElementById('B4').value,
                C1: document.getElementById('C1').value,
                C2: document.getElementById('C2').value,
                C3: document.getElementById('C3').value,
                C4: document.getElementById('C4').value,
                D1: document.getElementById('D1').value || defaultD1Value,
                D2: document.getElementById('D2').value,
                D3: document.getElementById('D3').value,
                D4: document.getElementById('D4').value,
              };
        
              // Envoyer les données à Google Sheets
              const sentSuccessfully = await sendDataToGoogleSheets(values);
              
              if (sentSuccessfully) {
                console.log('Données envoyées avec succès:', values);
                
                // Sauvegarder les verrouillages
                if (values.A1) {
                    saveLocks(values.A1, values.D1);
                }
                applyALocks();
                
                // Afficher la notification de succès
                showNotification('La tâche a été envoyée avec succès !');
              } else {
                console.error('Échec de l\'envoi des données');
                showNotification('Erreur lors de l\'envoi des données. Veuillez réessayer.', false);
              }
            }
        });
    </script>      
</body>
</html>
